AWSTemplateFormatVersion: "2010-09-09"
Description: Create an EC2 instance

Parameters:
  SSHLocation:
    Description: IP for SSH access
    Type: String
    Default: 58.11.11.14/32
  NvmUrl:
    Description: URL for nvm install
    Type: String
    Default: "https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.4/install.sh"

Resources:
  MyEC2Instance:
    Type: "AWS::EC2::Instance"
    Metadata:
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              ruby: []
          files:
            /home/ec2-user/install:
              source:
                Fn::Join:
                  - ""
                  - - "https://aws-codedeploy-"
                    - Ref: "AWS::Region"
                    - ".s3.amazonaws.com/latest/install"
              mode: "000755"
          commands:
            00-install-agent:
              command: "./install auto"
              cwd: "/home/ec2-user/"
            01-cfn-signal:
              command:
                Fn::Join:
                  - ""
                  - - "/opt/aws/bin/cfn-signal -e 0 --stack "
                    - Ref: "AWS::StackName"
                    - " --resource SampleLinuxInstance --region "
                    - Ref: "AWS::Region"
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT5M
    Properties:
      ImageId: "ami-0a481e6d13af82399"
      InstanceType: "t2.micro"
      KeyName: "EC2 Tutorial"
      SecurityGroups:
        - !Ref MySecurityGroup
      Tags:
        - Key: "Name"
          Value: "WebSimple"
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum -y update
          yum -y install cfn-bootstrap
          /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource SampleLinuxInstance --region ${AWS::Region}

          curl -o- ${NvmUrl} | bash
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm install --lts

          cat <<EOF >> /home/ec2-user/.bashrc
          export NVM_DIR="/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          EOF
  MySecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupName: web-simple
      GroupDescription: Enable HTTP access
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
  CodeDeployApplication:
    Type: AWS::CodeDeploy::Application
    Properties:
      ApplicationName: Web-simple
      ComputePlatform: Server
  DeploymentGroup:
    Type: AWS::CodeDeploy::DeploymentGroup
    DependsOn: MyEC2Instance
    Properties:
      ApplicationName: !Ref CodeDeployApplication
      DeploymentConfigName: CodeDeployDefault.AllAtOnce
      DeploymentGroupName: Web-simple-group
      ServiceRoleArn: arn:aws:iam::868133316193:role/CodeDeployServiceRole
      Ec2TagSet:
        Ec2TagSetList:
          - Ec2TagGroup:
              - Key: Name
                Value: WebSimple
                Type: KEY_AND_VALUE
